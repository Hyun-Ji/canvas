var through = require('through2');
var gutil = require('gulp-util');
var debug = require('debug')('umi:concat');
var PluginError = gutil.PluginError;
var File = gutil.File;

var pluginName = 'umi:concat';

module.exports = function() {
  var data = [];

  return through.obj(function transform(file, enc, cb) {
    debug('transform file %s %s', file.path, file.relative);

    if (file.isStream()) {
      return cb(new PluginError(pluginName, 'Streaming not supported.'));
    }

    data.push(file);
    cb();
  }, function flush(cb) {
    // use the filename of the first
    var first = data[0];

    data = data.map(function(file) {
      return file.contents;
    }).join('');

    var newFile = new File({
      cwd: first.cwd,
      base: first.base,
      path: first.path,
      contents: new Buffer(data)
    });
    data = [];
    debug('concat result %s', newFile.path);
    this.push(newFile);
    cb();
  });
    
};
