var EventProxy = require('eventproxy');
var Package = require('father').SpmPackage;
var buildArgs = require('./build-args');
var buildFile = require('./build-file');

module.exports = build;

function build(dir, options, cb) {
  var ep = new EventProxy();
  var args = buildArgs(options);
  var pkg = new Package(args.cwd, {extraDeps: {handlebars: 'handlebars'}});
  args.pkg = pkg;

  var output = [pkg.main];
  if (args.output) {
    output = output
      .concat(pkg.output)
      .filter(function(item, index, arr) {
        return index === arr.indexOf(item);
      });
  }

  ep.after('build', output.length, cb);

  output.forEach(function(file) {
    buildFile(file, args, function() {
      ep.emit('build');
    });
  });
}
